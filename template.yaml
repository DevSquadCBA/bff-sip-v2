AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Sistema integral Provimat backend en typescript'

Parameters:
    Environment:
        Type: String
        Description: 'entorno de desarrollo'
    RetentionInDays:
        Type: Number
        Description: Retention in days cloudwatch logs
        Default: '7'
    Debug:
        Type: String
        Description: Debug mode for logs
        Default: 'false'
        AllowedValues:
            - true
            - false

Globals:
    Function:
        Runtime: nodejs18.x
        Timeout: 30
        MemorySize: 128
        Environment:
            Variables:
                HOST: !Sub '{{resolve:ssm:/host}}'
                USER: !Sub '{{resolve:ssm:/user}}'
                PASS: !Sub '{{resolve:ssm:/pass}}'
                DB:   !Sub '{{resolve:ssm:/${Environment}/database}}'
                DEFAULT_LIMIT: 100 # El l√≠mite de recursos que trae por defecto
                NODE_CONFIG_DIR: !Sub '/opt/nodejs/config/'
                NODE_ENV: !Ref Environment
                NODE_OPTIONS: --enable-source-maps
                LAYER: '/opt/nodejs'
                LOCAL: 'false'
                DEBUG: !Ref Debug

Conditions:
    IsProduction:
        Fn::Equals: [Ref: Environment, prodblue]
    DefinedDomainName:
        Fn::Not:
            - Fn::Equals:
                - Fn::FindInMap: ['Stage', Ref: Environment, 'DomainName']
                - ''
    CreateDomainName:
        Condition: DefinedDomainName

### ENV VARS ###
Mappings:
    Stage:
        develop:
            DomainName: 'dev-sip.devsquadcba.com'
        prodblue:
            DomainName: 'sip.devsquadcba.com'
    Static:
        Parameters:
            FilterPattern: '[event=REPORT* || event="*DATADOG_EVENT*"]'


Resources:
    GetParametersRole:
        Type: 'AWS::IAM::Role'
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                        Service:
                            - 'lambda.amazonaws.com'
                      Action:
                        - 'sts:AssumeRole'
            Path: '/'
            ManagedPolicyArns:
                - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
            RoleName: !Sub '${Environment}-GetParametersRole'
            Policies:
                - PolicyName: ReadSsmParameters
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: Allow
                            Action:
                                - ssm:GetParameter
                                - ssm:GetParameters
                            Resource:
                                Fn::Sub: arn:aws:ssm:*:${AWS::AccountId}:parameter/${Environment}/*
    ProvimatRestApi:
        Type: AWS::Serverless::Api
        Properties:
#            ApiId: gyl18gwcs5
            StageName: !Ref Environment
            Name: !Sub ${AWS::StackName}-api
            OpenApiVersion: 3.0.1
            TracingEnabled: true
            Cors:
                AllowOrigin:  "'*'"
                AllowHeaders: "'*'" 
            DefinitionBody:
                Fn::Transform:
                    Name: AWS::Include
                    Parameters:
                        Location: ./swagger.yaml
    BasePathMapping:
        Type: AWS::ApiGateway::BasePathMapping
        DependsOn: ProvimatRestApi
        Condition: CreateDomainName
        Properties:
            BasePath: 'api'
            DomainName: !Sub '${Stage.${Environment}.DomainName}'
            RestApiId: !Ref ProvimatRestApi
            Stage: !Ref ProvimatRestApi.Stage    

# Layers
    Mysql2Layer:
        Type: AWS::Serverless::LayerVersion
        Properties:
            LayerName: !Sub '${Environment}-MysqlLayer'
            Description: 'Layer que contiene mysql2'
            ContentUri: ./src/layers/nodejs
            CompatibleRuntimes:
                - nodejs16.x

# Admin
    SyncDbFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-SyncDb'
            Handler: syncDb.Handler
            CodeUri: ./src/functions/admin
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /admin/syncDb
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    FakeDataFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-FakeData'
            Handler: fakeData.Handler
            CodeUri: ./src/functions/admin
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /admin/fakeData
                        Method: GET
                        ApiId: !Ref ProvimatRestApi

# Clients
    GetClientsFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                # MainFields: "module,main"
                Minify: true
                Sourcemap: true
        Properties:
            FunctionName: !Sub '${Environment}-GetClients'
            Handler: getClients.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    GetClientsListFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                MainFields: "module,main"
                Minify: true
                Sourcemap: true
        Properties:
            FunctionName: !Sub '${Environment}-GetClients-List'
            Handler: getClientsList.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /clients
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    GetClientByIdFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetClientById'
            Handler: getClientById.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client/{idClient}
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    CreateClientFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-CreateClient'
            Handler: createClient.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client
                        Method: POST
                        ApiId: !Ref ProvimatRestApi
    UpdateClientsFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-UpdateClients'
            Handler: updateClient.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client/{idClient}
                        Method: PUT
                        ApiId: !Ref ProvimatRestApi
    DeleteClientsFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-DeleteClients'
            Handler: deleteClient.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client/{idClient}
                        Method: DELETE
                        ApiId: !Ref ProvimatRestApi

# Sale
    CreateSaleFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-CreateSale'
            Handler: createSale.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sale
                        Method: POST
                        ApiId: !Ref ProvimatRestApi
    GetSalesFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetSale'
            Handler: getSales.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sales
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    GetSaleByIdFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetSaleById'
            Handler: getSaleById.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sale/{idSale}
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    UpdateSaleFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Update-Sale'
            Handler: updateSale.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sale/{idSale}
                        Method: PUT
                        ApiId: !Ref ProvimatRestApi
    DeleteSaleFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Delete-Sale'
            Handler: deleteSale.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sale/{idSale}
                        Method: DELETE
                        ApiId: !Ref ProvimatRestApi
    GetClientSaleFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetClient-Sale'
            Handler: getClientSales.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /client/{idClient}/sales
                        Method: GET 
                        ApiId: !Ref ProvimatRestApi
    AddOrRemoveProductsFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-addOrRemoveProducts'
            Handler: addOrRemoveProducts.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /sale/{idSale}/addProducts
                        Method: POST
                        ApiId: !Ref ProvimatRestApi
# # Products
    CreateProductFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-CreateProduct'
            Handler: createProduct.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /product
                        Method: POST
                        ApiId: !Ref ProvimatRestApi
    GetProductsFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetProducts'
            Handler: getProducts.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /product
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    GetProductByIdFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetProductById'
            Handler: getProductById.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /product/{idProduct}
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    GetProductWithProviderFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetProductWithProvider'
            Handler: getProductWithProvider.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /products
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    DeleteProductFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-delete-Product'
            Handler: deleteProduct.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /product/{idProduct}
                        Method: DELETE
                        ApiId: !Ref ProvimatRestApi
    UpdateProductFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Update-Product'
            Handler: updateProduct.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /product/{idProduct}
                        Method: PUT
                        ApiId: !Ref ProvimatRestApi

# Providers
    CreateProviderFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                # MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Create-Provider'
            Handler: createProvider.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /provider
                        Method: POST
                        ApiId: !Ref ProvimatRestApi
    GetProvidersFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                # MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetProviders'
            Handler: getProviders.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /provider
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    DeleteProviderFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Delete-Provider'
            Handler: deleteProvider.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /provider/{idProvider}
                        Method: DELETE
                        ApiId: !Ref ProvimatRestApi
    GetProviderByIdFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetProvider-ById'
            Handler: getProviderById.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /provider/{idProvider}
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    UpdateProviderFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Update-Provider'
            Handler: updateProvider.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /provider/{idProvider}
                        Method: PUT
                        ApiId: !Ref ProvimatRestApi

## Funciones de b√∫squeda
    SearchClientFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-GetClients'
            Handler: searchClient.Handler
            CodeUri: ./src/functions/client
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /search/client
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    SearchSaleFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-SearchSale'
            Handler: searchSale.Handler
            CodeUri: ./src/functions/sale
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /search/sale
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    SearchProductFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-SearchProduct'
            Handler: searchProduct.Handler
            CodeUri: ./src/functions/product
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /search/product
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
    SearchProviderFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-SearchProvider'
            Handler: searchProvider.Handler
            CodeUri: ./src/functions/provider
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /search/provider
                        Method: GET
                        ApiId: !Ref ProvimatRestApi
#     UpdateProductPricesFunction:
#         Type: AWS::Serverless::Function
#         Metadata:
#             BuildMethod: esbuild
#             BuildProperties:
#                 Minify: true
#                 Sourcemap: true
#         Properties:
#             FunctionName: !Sub '${Environment}-Update-Product-Prices'
#             Handler: updateProductPricesFromProvider.Handler
#             CodeUri: ./src/functions/provider
#             Events:
#                 HttpEvent:
#                     Type: HttpApi
#                     Properties:
#                         Path: /provider/{idProvider}
#                         Method: POST
#                         ApiId: !Ref ProvimatRestApi

# Utils
    CountFunction:
        Type: AWS::Serverless::Function
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Minify: true
                Sourcemap: true
                MainFields: "module,main"
        Properties:
            FunctionName: !Sub '${Environment}-Count'
            Handler: count.Handler
            CodeUri: ./src/functions/utils
            Events:
                HttpEvent:
                    Type: HttpApi
                    Properties:
                        Path: /count
                        Method: GET
                        ApiId: !Ref ProvimatRestApi

# Esta url nunca cambia
Outputs:
    ApiUrl:
        Description: URL de la API
        Value: !Sub "https://${ProvimatRestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"